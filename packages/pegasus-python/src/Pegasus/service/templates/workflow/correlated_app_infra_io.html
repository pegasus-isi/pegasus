{% macro status_code(exitcode=None) -%}
    {% if exitcode == None %}"running"{% elif exitcode !=  0 %}"failed"{% else %}"successful"{% endif %}
{%- endmacro %}
{% extends "base.html" %}
{% block title %}Anomaly Details{% endblock %}
{% block javascript_includes %}

    <script src="//code.highcharts.com/stock/highstock.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='js/influxdb-latest.js') }}"></script>
{% endblock %}
{% block javascript_init %}
    <script type="text/javascript" charset="utf-8">
        var influxdb_url = document.createElement('a');

        var anomaly = {{ anomaly.json|tojson }};
        var metrics = anomaly.metrics;
        var message = anomaly.message;
        var startTime = endTime = null;
        var series = {};

        influxdb_url.href = '{{ config.INFLUXDB_URL }}';

        function plotChart() {
            $('#chart').highcharts('StockChart', {
                chart: {
                    height: 600
                },

                rangeSelector: {
                    enabled: false
                },

                navigator: {
                    enabled: false
                },

                scrollbar: {
                    enabled: false
                },

                credits: {
                    enabled: false
                },

                title: {
                    text: 'Correlated Application and Infrastructure Anomaly'
                },

                subtitle: {
                    text: message
                },

                plotOptions: {
                    area: {
                        marker: {
                            enabled: true,
                            radius: 3
                        },
                        colors: ['#7cb5ec', '#434348', '#7cb5ec', '#f7a35c', '#8085e9',
                            '#f15c80', '#e4d354', '#8085e8', '#8d4653', '#91e8e1'],
                    }
                },

                xAxis: {
                    plotBands: [{
                        color: 'rgba(255, 0, 0, .6)',
                        width: 3,
                        value: {{ anomaly.ts }},
                        zIndex: 100,
                        label: {
                            text: 'Anomaly'
                        }
                    }]
                },

                yAxis: [
                    {
                        labels: {
                            align: 'right',
                            x: -3
                        },
                        title: {
                            text: metrics.kickstart[0],
                            style: {
                                fontSize: '1.35em',
                                fontWeight: 'bold'
                            }
                        },
                        height: '30%',
                        lineWidth: 2
                    },
                    {
                        labels: {
                            align: 'right',
                            x: -3
                        },
                        title: {
                            text: metrics.infra,
                            style: {
                                fontSize: '1.35em',
                                fontWeight: 'bold'
                            }
                        },
                        top: '35%',
                        height: '30%',
                        offset: 0,
                        lineWidth: 2
                    },
                    {
                        labels: {
                            align: 'right',
                            x: -3
                        },
                        title: {
                            text: metrics.kickstart[1],
                            style: {
                                fontSize: '1.35em',
                                fontWeight: 'bold'
                            }
                        },
                        top: '68%',
                        height: '30%',
                        offset: 0,
                        lineWidth: 2
                    }],

                series: [
                    {
                        type: 'area',
                        name: metrics.kickstart[0],
                        data: series[metrics.kickstart[0]],
                        yAxis: 0,
                        color: '#7cb5ec'
                    },
                    {
                        type: 'area',
                        name: metrics.infra,
                        data: series[metrics.infra],
                        yAxis: 1,
                        color: '#8d4653'
                    },
                    {
                        type: 'area',
                        name: metrics.kickstart[1],
                        data: series[metrics.kickstart[1]],
                        yAxis: 2,
                        color: '#7cb5ec'
                    }]
            });
        }

        function kickstartData(data) {
            startTime = data[0].points[data[0].points.length - 1].time.getTime();
            endTime = data[0].points[0].time.getTime();

            for (var j = 0; j < metrics.kickstart.length; ++j) {
                var points = [];

                for (var i = data[0].points.length - 1; i >= 0; --i) {
                    var x = data[0].points[i].time;
                    var y = data[0].points[i][metrics.kickstart[j]];

                    points.push([x.getTime(), y]);
                }

                series[metrics.kickstart[j]] = points;
            }

            var influxdb = new InfluxDB({
                host: influxdb_url.hostname,
                port: influxdb_url.port,
                username: '{{ config.INFLUXDB_USER }}',
                password: '{{ config.INFLUXDB_PASS }}',
                ssl: influxdb_url.protocol == 'https:',
                database: anomaly.infra_db_io
            });

            getInfrastructureMetricsData(influxdb);
        }

        function infrstructureData(data) {
            var points = [];

            /*
             * Valid Infrastructure Series:
             *  Must have data `data.length`
             *  Last data-point in series must be after the job's startTime
             *  First data-point in series must be before the job's endTime
             */
            if (data.length && data[0].points[0].time.getTime() >= startTime && data[0].points[data[0].points.length - 1].time.getTime() <= endTime) {
                var first = true;

                for (var i = data[0].points.length - 1; i >= 0; --i) {
                    var x = data[0].points[i].time.getTime();
                    var y = data[0].points[i][metrics.infra];

                    if (first) {
                        if (i - 1 >= 0) {
                            var diff = startTime - data[0].points[i - 1].time.getTime();

                            if (diff < 0) {
                                first = false;
                            } else {
                                continue;
                            }
                        }
                    } else {
                        if (endTime <= data[0].points[i + 1].time.getTime()) {
                            break;
                        }
                    }

                    points.push([x, y]);
                }
            }

            series[metrics.infra] = points;
            plotChart();
        }

        function getKickstartMetricsData(influxdb) {
            data = influxdb.readPoint(metrics.kickstart, '"{{ anomaly.dag_job_id }}:{{ job_instance.sched_id }}"', kickstartData);
        }

        function getInfrastructureMetricsData(influxdb) {
            var query = 'SELECT ' + metrics.infra + ' FROM "' + anomaly.infra_series_io + '" WHERE time > ' +
                    ((startTime / 1000) - 10) + 's AND time < ' + ((endTime / 1000) + 10) + 's;';
            console.debug(query);
            data = influxdb.query(query, infrstructureData);
        }

        $(function () {
            plotChart();

            var influxdb = new InfluxDB({
                host: influxdb_url.hostname,
                port: influxdb_url.port,
                username: '{{ config.INFLUXDB_USER }}',
                password: '{{ config.INFLUXDB_PASS }}',
                ssl: influxdb_url.protocol == 'https:',
                database: '{{ workflow.dax_label }}:{{ workflow.wf_uuid }}'
            });

            getKickstartMetricsData(influxdb);
        });

    </script>
{% endblock %}
{% block css_includes %}
    <style>
    </style>
{% endblock %}
{% block navigation_bar %}
    <li><a href="{{ url_for ('.workflow', root_wf_id = root_wf_id, wf_id = wf_id) }}">Workflow</a></li>
    {% if anomaly.job_instance_id != None %}
        <li>
            <a href="{{ url_for ('.job', root_wf_id = root_wf_id, wf_id = wf_id, job_id = job.job_id, job_instance_id = job_instance.job_instance_id) }}">Job</a>
        </li>
    {% endif %}
    <li class="active">Anomaly</li>
{% endblock %}
{% block title_header %}Anomaly Details{% endblock %}
{% block content %}
    <section class="row">
        <div class="col-xs-12">

        </div>
    </section>

    <section class="row">
        <div id="chart" class="col-xs-12">

        </div>
    </section>
{% endblock %}
