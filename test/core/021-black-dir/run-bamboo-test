#!/bin/bash

set -e
set -v


if [ X${testdir} = "X" ]; then
    testdir=`dirname  $0`
    export testdir
fi

TOPDIR=`pwd`

# generate the input file
input_dir=./input
mkdir $input_dir
echo "This is sample input to KEG" > ./input/f.a

# output directory
# this is the one we put in site catalog
mkdir -p outputs

#create a test output directory
output_dir=./output
mkdir -p $output_dir

# build the dax generator
export CLASSPATH=.:${CLASSPATH}
javac $testdir/BlackDiamondDAX.java

# generate the dax
java BlackDiamondDAX /usr blackdiamond.dax

# create the site catalog
cat >sites.xml <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!-- generated: 2016-04-15T15:15:02-07:00 -->
<!-- generated by: vahi [??] -->
<sitecatalog xmlns="http://pegasus.isi.edu/schema/sitecatalog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://pegasus.isi.edu/schema/sitecatalog http://pegasus.isi.edu/schema/sc-4.0.xsd" version="4.0">
<site  handle="condorpool" arch="x86_64" os="LINUX" osrelease="" osversion="" glibc="">
	<directory  path="/scitech/shared/scratch-90-days/bamboo/scratch" type="shared-scratch" free-size="" total-size="">
		<file-server  operation="all" url="scp://bamboo@bamboo.isi.edu/scitech/shared/scratch-90-days/bamboo/scratch">
		</file-server>
	</directory>
	<directory  path="/scitech/shared/scratch-90-days/bamboo/outputs" type="shared-storage" free-size="" total-size="">
		<file-server  operation="all" url="scp://bamboo@bamboo.isi.edu/scitech/shared/scratch-90-days/bamboo/outputs">
		</file-server>
	</directory>
	<profile namespace="env" key="PEGASUS_HOME" >/usr</profile>
	<profile namespace="condor" key="universe" >vanilla</profile>
	<profile namespace="pegasus" key="style" >condor</profile>
  <profile namespace="pegasus" key="ssh_private_key" >/scitech/shared/home/bamboo/.ssh/workflow_id_rsa</profile>
</site>
<site  handle="local" arch="x86_64" os="LINUX" osrelease="rhel" osversion="7" glibc="">
	<directory  path="$TOPDIR/work" type="shared-scratch" free-size="" total-size="">
		<file-server  operation="all" url="file://$TOPDIR/work">
		</file-server>
	</directory>
	<profile namespace="pegasus" key="clusters.num" >1</profile>
</site>
</sitecatalog>
EOF

# plan and submit the  workflow
pegasus-plan \
    --conf $testdir/pegasusrc \
    --sites condorpool \
    --dir work \
    --input-dir $input_dir \
    --output-dir $output_dir \
    --submit blackdiamond.dax | tee plan.out
